
<!DOCTYPE html>
<html>
    <head>
        <title>Experiment</title>
        <script src="jspsych-6.3.1/jspsych.js"></script>
        <link href="jspsych-6.3.1/css/jspsych.css" rel="stylesheet" type="text/css">
        <script src="jspsych-6.3.1/plugins/jspsych-survey-text.js"></script>
        <script src="jspsych-6.3.1/plugins/jspsych-preload.js"></script>
        <script src="input_files/filenames.js"></script>
        <script src="jspsych-6.3.1/plugins/jspsych-html-keyboard-response.js"></script>
        <script src="jspsych-6.3.1/plugins/jspsych-audio-keyboard-response.js"></script>
    </head>
    <body></body>
    
    <script>
        var old_subj_num = null;
        var new_subj_num = null;
        
        function save_to_id_folder(name, data){
          var form_data = new FormData();
          form_data.append("data",data);
          form_data.append("filename",name);
          var xhr = new XMLHttpRequest();
          xhr.open('POST', 'save_to_id_folder.php', true);
          xhr.onreadystatechange = function (oEvent) {
            if (xhr.readyState === 4) {
                if (xhr.status === 200) {
                  console.log(xhr.responseText)
                } else {
                  console.log("Error", xhr.statusText);
                }
            }
          };
          xhr.send(form_data);
        }
    
        function check_folderID(){
            var xhr = new XMLHttpRequest();
            xhr.open('POST', 'check_folderID.php', false);
            xhr.onreadystatechange = function(Event){
                if(xhr.readyState === 4){
                    if (xhr.status === 200){
                        var num = xhr.responseText;
                        old_subj_num = num;
                        select_trialList(num);
                    }
                    else{
                        console.log("Error", xhr.statusText);
                    }
                }
            }
            xhr.send(null);
        }
    
        async function select_trialList(num){
            var list_num = parseInt(num) + 1;
            new_subj_num = list_num;
            var trial_list_file = 'triallists/trialList_subject' + list_num + '.json';
            
            // get json
        }
    

        check_folderID();
        
        var timeline = [];
        
        // subject id
        var subj_id_req = {
            type: 'survey-text',
            questions: [{prompt: 'Please type your Prolific ID in the box and then click "Continue"', placeholder: 'Prolific ID', rows: 1, columns: 25, name: 'subject_id', required: true},],
            data: {
                data_type: 'info'
            },
            on_finish: function(data){
                d = new Date();
                data.timestamp = d.toString();
                user_input_id = jsPsych.data.get().values()[0].response
                // create csv in id_folder
                save_to_id_folder('subj_' + String(user_input_id.subject_id) + '_trialList_'+new_subj_num, "");
            }
        }
        timeline.push(subj_id_req);
        
        // preload audio
        var preload_audio = {
            type: 'preload',
            audio: filenames
        }
        timeline.push(preload_audio)
    
        // prompt participant to use headphones
        var headphones = {
            type: 'survey-text',
            questions: [{prompt: 'Please confirm you will be using headphones by typing "I will use headphones" in the box.', required: true}],
            data: {
                data_type: 'info'
            },
            button_label: "Continue",
            on_finish: function(data) {
                d = new Date();
                data.timestamp = d.toString();
            }
        }
        timeline.push(headphones)
        
        // more instructions
        var instructions = {
            type: "html-keyboard-response",
            stimulus: `
                <p> Before we start, please make sure that:</p>
                <p> 1) you are sitting at a quiet place </p>
                <p> 2) devices or apps that might be making noise are turned off </p>
                <p> 3) all other web pages except this one are closed </p>
                <p> All the recordings in the experiment will only be played once, so please pay attention. </p>
                <br></br>
                <p> Press any key to continue </p>`,
            data: {
                data_type: 'info'
            },
            on_finish: function(data) {
                d = new Date();
                data.timestamp = d.toString();
            }
        }
        timeline.push(instructions);
        
        // volume test
        var volume_instructions = {
            type: "html-keyboard-response",
            stimulus:`
                <p>You will hear a recording in the next part.</p>
                <p>Adjust your headphone volume to what is best for you when you listen to the recording.</p>
                <p>Press any key to continue. </p>
                `,
            data: {
                data_type: 'info'
            },
            on_finish: function(data){
                d = new Date();
                data.timestamp = d.toString();
            }
        };
        timeline.push(volume_instructions);
        
        var volume_adjust = {
            type: 'audio-keyboard-response',
            prompt: '<p> Adjust your headphone volume using this recording. </p> <p> Press any key to continue when you are finished </p>',
            stimulus: "soundFiles/_volumetest.ogg",
            data: {
                data_type: 'info'
            }
        };
        timeline.push(volume_adjust);
        
        // more trial instructions
        var trial_instructions = {
            type: "html-keyboard-response",
            stimulus: `
                <p> In this experiment, you will hear multiple content-impaired sentences in various languages.</p>
                <p> After hearing two recordings, you will be asked to rate how similar the languages in the two recordings sound to you on a scale of 1 to 7. </p>
                <p> If the two recordings sound like they are the same language, you should click 7. If the two recordings sound like they are entirely different languages, you should click 1. </p>
                <p> Each recording will only be played once, so please pay attention. </p>
                <p> At the end of every 10 trials, there is a chance to take a break if needed. </p>
                <br></br>
                <p> Press any key to continue.
                `,
            data: {
                data_type: 'info'
            },
            on_finish: function(data) {
                d = new Date();
                data.timestamp = d.toString();
            }
        }
        timeline.push(trial_instructions);
        
        jsPsych.init({
            timeline: timeline
        })
    </script>
</html>


